<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة التاجر</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body{margin:0;background:#0b1020;color:#e2e8f0;font-family:"Cairo",system-ui}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .card{background:rgba(16,25,54,.7);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#e2e8f0}
    input[type="search"]{min-width:260px}
    button{background:linear-gradient(135deg,#6366f1,#494ce0);border:none;font-weight:800;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:start}
    .muted{color:#94a3b8}
    .pill{display:inline-block;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.3);color:#86efac;padding:6px 10px;border-radius:999px;font-weight:800}
    .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);display:none;padding:10px 12px;border-radius:12px}
    .ok{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.35)}
    .err{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35)}
    .grow{flex:1 1 auto}
  </style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="wrap">
  <h1 style="margin:0 0 12px">لوحة التاجر</h1>

  <!-- تسجيل الدخول -->
  <div class="card" id="loginCard">
    <h3 style="margin:0 0 8px">تسجيل دخول التاجر</h3>
    <div class="row">
      <input id="merchantCode" placeholder="ادخل كود التاجر (مثال: MRC-1234)" />
      <button id="merchantLoginBtn">دخول</button>
      <a href="/login.html" style="margin-inline-start:auto;color:#94a3b8;text-decoration:none">رجوع لتسجيل موحّد</a>
    </div>
    <div class="muted" style="margin-top:6px">الكود تمنحه أنت للتاجر.</div>
  </div>

  <!-- بعد الدخول -->
  <div id="dash" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>
          <div id="mName" style="font-weight:800;font-size:18px">—</div>
          <div class="muted" id="mCode">—</div>
        </div>
        <div class="pill" id="mPct">خصم: 0%</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">إضافة عملية خصم</h3>
      <div class="row">
        <input id="clientCode" placeholder="كود العميل" />
        <input id="billTotal" type="number" min="0" placeholder="مبلغ الفاتورة" inputmode="numeric" />
        <button id="calcBtn">احسب</button>
        <button id="confirmBtn" disabled>تأكيد</button>
      </div>
      <div id="preview" class="muted" style="margin-top:8px;display:none"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">عملائي</h3>
        <div class="row">
          <input id="searchCustomer" type="search" placeholder="ابحث باسم/هاتف/كود العميل..." />
          <button id="clearSearchBtn" class="muted" style="background:rgba(255,255,255,.06)">مسح</button>
          <button id="refreshBtn">تحديث</button>
        </div>
      </div>
      <div id="stats" class="muted" style="margin-top:6px"></div>
      <table id="tbl"><thead>
        <tr>
          <th>العميل</th>
          <th>الهاتف</th>
          <th>الزيارات</th>
          <th>آخر زيارة</th>
          <th>إجمالي فواتير</th>
          <th>إجمالي خصم</th>
        </tr>
      </thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
const toast=(t,c='ok')=>{const x=document.getElementById('toast');x.className='toast '+c;x.textContent=t;x.style.display='block';clearTimeout(x._t);x._t=setTimeout(()=>x.style.display='none',2200)};
const BASE=''; // نفس الدومين

let MERCH=null;              // {code,name,discount_percent}
let ALL_CUSTOMERS=[];        // آخر بيانات العملاء من الـ API (قبل الفلترة)

function setAuth(h){ if(MERCH) h['x-merchant-code']=MERCH.code; return h;}

async function post(path,body,h={}){ const r=await fetch(BASE+path,{method:'POST',headers:Object.assign({'Content-Type':'application/json'},setAuth(h)),body:JSON.stringify(body)}); const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error(j.error||('HTTP '+r.status)); return j; }
async function get(path,h={}){ const r=await fetch(BASE+path,{headers:setAuth(h)}); const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error(j.error||('HTTP '+r.status)); return j; }

function hydrateFromStorage(){
  const s = localStorage.getItem('merchantLogin');
  if(!s) return false;
  try{
    MERCH = JSON.parse(s);
    if(!MERCH?.code) return false;
    document.getElementById('loginCard').style.display='none';
    document.getElementById('dash').style.display='block';
    document.getElementById('mName').textContent=MERCH.name||'—';
    document.getElementById('mCode').textContent='كود: '+(MERCH.code||'—');
    document.getElementById('mPct').textContent='خصم: '+(MERCH.discount_percent||0)+'%';
    return true;
  }catch{ return false; }
}

document.getElementById('merchantLoginBtn').onclick=async()=>{
  const code=document.getElementById('merchantCode').value.trim();
  if(!code) return toast('دخل كود التاجر','err');
  try{
    const res=await fetch('/api/merchant/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({merchant_code:code})});
    const j=await res.json(); if(!res.ok) throw new Error(j.error||res.status);
    MERCH=j;
    localStorage.setItem('merchantLogin', JSON.stringify(j));
    document.getElementById('loginCard').style.display='none';
    document.getElementById('dash').style.display='block';
    document.getElementById('mName').textContent=j.name||'—';
    document.getElementById('mCode').textContent='كود: '+(j.code||'—');
    document.getElementById('mPct').textContent='خصم: '+(j.discount_percent||0)+'%';
    await loadCustomers();
    toast('تم الدخول');
  }catch(e){ toast(e.message,'err'); }
};

document.getElementById('calcBtn').onclick=async()=>{
  const client_code=document.getElementById('clientCode').value.trim();
  const total=Number(document.getElementById('billTotal').value||0);
  if(!client_code||!total) return toast('أكمل الحقول','err');
  const pct=Number(MERCH?.discount_percent||0);
  const discount=Math.round(total*pct)/100;
  const payable=Math.max(0,total-discount);
  document.getElementById('preview').style.display='block';
  document.getElementById('preview').innerHTML=`المبلغ: <b>${total.toLocaleString('ar-IQ')}</b> | الخصم: <b>${discount.toLocaleString('ar-IQ')}</b> | المستحق: <b>${payable.toLocaleString('ar-IQ')}</b>`;
  document.getElementById('confirmBtn').disabled=false;
};

document.getElementById('confirmBtn').onclick=async()=>{
  try{
    const client_code=document.getElementById('clientCode').value.trim();
    const bill_total=Number(document.getElementById('billTotal').value||0);
    const j=await post('/api/merchant/redeem',{client_code,bill_total});
    toast('تم تسجيل العملية ✅');
    document.getElementById('confirmBtn').disabled=true;
    document.getElementById('preview').style.display='none';
    document.getElementById('clientCode').value='';
    document.getElementById('billTotal').value='';
    await loadCustomers();
  }catch(e){ toast(e.message,'err'); }
};

/* =========================
   البحث + عرض الجدول
   ========================= */
function normalize(s){
  return String(s||'')
    .replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d)) // تحويل أرقام عربية لإنكليزية
    .replace(/[أإآ]/g,'ا')
    .trim().toLowerCase();
}

function renderCustomers(list){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name||'—'} <div class="muted">${r.client_code||''}</div></td>
                  <td>${r.phone||'—'}</td>
                  <td>${r.visits||0}</td>
                  <td>${r.last_visit? new Date(r.last_visit).toLocaleString('ar-IQ'): '—'}</td>
                  <td>${Number(r.total_bill||0).toLocaleString('ar-IQ')}</td>
                  <td>${Number(r.total_discount||0).toLocaleString('ar-IQ')}</td>`;
    tb.appendChild(tr);
  });
}

function applyCustomerFilter(){
  const q = normalize(document.getElementById('searchCustomer').value);
  if(!q){ renderCustomers(ALL_CUSTOMERS); return; }
  const filtered = ALL_CUSTOMERS.filter(c=>{
    const hay = normalize(`${c.name||''} ${c.phone||''} ${c.client_code||''}`);
    return hay.includes(q);
  });
  renderCustomers(filtered);
}

document.getElementById('searchCustomer').addEventListener('input', applyCustomerFilter);
document.getElementById('clearSearchBtn').addEventListener('click', ()=>{
  document.getElementById('searchCustomer').value='';
  applyCustomerFilter();
});

async function loadCustomers(){
  try{
    const j=await get('/api/merchant/customers');
    const s=j.stats||{};
    const avg=(s.avg_visits_per_client ?? s.avgVisitsPerClient ?? 0);
    document.getElementById('stats').textContent=
      `عدد العملاء: ${s.unique_clients||0} | مجموع الزيارات: ${s.total_visits||0} | معدل التكرار: ${Number(avg||0).toFixed(2)}`;
    ALL_CUSTOMERS = Array.isArray(j.customers)? j.customers : [];
    applyCustomerFilter(); // يعرض حسب البحث الحالي
  }catch(e){ toast(e.message,'err'); }
}
document.getElementById('refreshBtn').onclick=loadCustomers;

if(hydrateFromStorage()){ loadCustomers(); }
</script>
</body>
</html>
