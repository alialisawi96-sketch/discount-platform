<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل الدخول</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; --bg2:#0e1530;
      --card:rgba(16,25,54,.7); --bd:rgba(255,255,255,.06);
      --ink:#e2e8f0; --muted:#94a3b8; --pri:#6366f1; --pri-700:#494ce0;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);font-family:"Cairo",system-ui}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .stack{display:flex;flex-direction:column;align-items:center;gap:18px}

    .hero{display:flex;flex-direction:column;align-items:center;text-align:center;gap:12px}
    .hero img.logo{
      width:min(360px,70vw);height:auto;object-fit:contain;
      filter:grayscale(1) brightness(0) invert(1) contrast(2);
      opacity:.98;user-select:none;-webkit-user-drag:none;display:block;
    }
    .brandWordmark{display:none;font-weight:900;font-size:42px;letter-spacing:.18em;text-transform:uppercase;color:#fff;opacity:.95}
    .brandLine{font-weight:800;font-size:28px;letter-spacing:.3px}
    .heroGif{width:min(260px,58vw);height:auto;display:none;border-radius:14px;border:1px solid var(--bd);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    @media (max-width:520px){ .brandLine{font-size:22px} .brandWordmark{font-size:34px} }

    .card{width:min(520px,95vw);background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{
      padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);color:var(--ink);outline:none
    }
    input,select{flex:1 1 160px}
    button{background:linear-gradient(135deg,var(--pri),var(--pri-700));border:none;font-weight:800;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stack">
      <!-- ===== الشعار + السطر التعريفي ===== -->
      <div class="hero">
        <img id="logoImg" class="logo" alt="Discount logo" referrerpolicy="no-referrer">
        <div id="brandWordmark" class="brandWordmark">DISCOUNT</div>
        <div class="brandLine">منصة دسكاونت الإلكترونية</div>
        <img id="heroGif" class="heroGif" alt="Animated banner" loading="lazy" referrerpolicy="no-referrer">
      </div>

      <!-- ===== بطاقة تسجيل الدخول ===== -->
      <div class="card">
        <h2 style="margin:0 0 10px">تسجيل الدخول</h2>
        <div class="row">
          <select id="role" aria-label="اختيار الدور">
            <option value="client">عميل</option>
            <option value="merchant">تاجر</option>
          </select>
          <input id="code" placeholder="أدخل كود العميل" autocomplete="one-time-code" inputmode="numeric" />
          <!-- أضفنا type="button" لمنع أي سلوك إرسال GET افتراضي -->
          <button id="loginBtn" type="button">دخول</button>
        </div>
        <div class="muted" style="margin-top:8px">اختر الدور وأدخل الكود المخصص إلك.</div>
        <div id="msg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- ===== سكربت موحّد (POST مضبوط + رسائل واضحة) ===== -->
  <script>
  const $ = id => document.getElementById(id);
  function msg(t, err=false){ const m=$('msg'); m.style.color = err?'#fca5a5':'#94a3b8'; m.textContent=t||''; }

  // تحويل الأرقام العربية/الفارسية إلى إنكليزية
  const mapAR='٠١٢٣٤٥٦٧٨٩', mapFA='۰۱۲۳۴۵۶۷۸۹';
  function normalizeDigits(s=''){
    return String(s)
      .replace(/[٠-٩]/g, d => mapAR.indexOf(d))
      .replace(/[۰-۹]/g, d => mapFA.indexOf(d))
      .trim();
  }

  // تحميل شعار وجيف من Google Drive مع fallback
  (function mountLogo(){
    const driveId = '1SIL4hnVs972b-wyTLN0PEy0buKsuBsft';
    const img = $('logoImg'), text = $('brandWordmark');
    const tries = [
      `https://drive.google.com/uc?export=view&id=${driveId}`,
      `https://drive.google.com/uc?id=${driveId}`,
      'logo-discount.svg','logo-discount.png','/logo-discount.svg','/logo-discount.png'
    ];
    let i=0; function next(){ if(i>=tries.length){ img.style.display='none'; text.style.display='block'; return; } img.src=tries[i++]; }
    img.onload=()=>{ img.style.display='block'; text.style.display='none'; };
    img.onerror=next; next();
  })();
  (function mountDriveGif(){
    const id='15NmI9__IIDtEGUrJG8O8grAU2feajcz6';
    const gif=$('heroGif');
    const tries=[
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/uc?id=${id}`
    ];
    let i=0; function load(){ if(i>=tries.length) return; gif.src=tries[i++]; }
    gif.onload=()=>{ gif.style.display='block'; };
    gif.onerror=load; load();
  })();

  // تهيئة الحقول
  (function initUI(){
    const lastRole = localStorage.getItem('lastRole') || 'client';
    $('role').value = lastRole;
    $('code').placeholder = lastRole==='client' ? 'أدخل كود العميل' : 'أدخل كود التاجر';
    const lastCode = localStorage.getItem('lastCode') || '';
    if(lastCode) $('code').value = lastCode;

    $('role').addEventListener('change', () => {
      $('code').placeholder = ($('role').value==='client') ? 'أدخل كود العميل' : 'أدخل كود التاجر';
      localStorage.setItem('lastRole', $('role').value);
    });
    $('code').addEventListener('keypress', e => { if(e.key==='Enter'){ $('loginBtn').click(); } });
  })();

  // تسجيل الدخول
  $('loginBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    msg('');

    const role = $('role').value;                       // client | merchant
    const code = normalizeDigits($('code').value);
    if(!code){
      msg('أدخل الكود', true);
      $('code').focus();
      return;
    }

    localStorage.setItem('lastRole', role);
    localStorage.setItem('lastCode', code);

    const btn=$('loginBtn'), old=btn.textContent;
    btn.disabled=true; btn.textContent='جاري التحقق...';

    const url  = role==='merchant' ? '/api/merchant/login' : '/api/login';
    const body = role==='merchant' ? { merchant_code: code } : { client_code: code };

    try{
      const r = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });

      const text = await r.text();
      let data={}; try{ data = JSON.parse(text); }catch{}
      if(!r.ok) throw new Error(data.error || ('HTTP '+r.status));

      if(role==='merchant'){
        localStorage.setItem('merchantLogin', JSON.stringify(data));
        localStorage.setItem('x-merchant-code', String(data.code || code));
        location.href = '/merchant.html';   // عدّل المسار إذا ملفّك مختلف
      }else{
        localStorage.setItem('clientLogin', JSON.stringify(data));
        localStorage.setItem('x-client-code', String(data.code || code));
        location.href = '/index.html';      // عدّل المسار إذا ملفّك مختلف
      }
    }catch(err){
      msg(err.message || 'تعذر تسجيل الدخول', true);
    }finally{
      btn.disabled=false;
      btn.textContent=old;
    }
  });
  </script>
</body>
</html>
